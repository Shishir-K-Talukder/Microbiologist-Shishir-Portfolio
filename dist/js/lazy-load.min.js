class e{constructor(e={}){this.options={rootMargin:"50px 0px",threshold:[0,.25,.5,.75,1],loadingClass:"lazy-loading",loadedClass:"lazy-loaded",errorClass:"lazy-error",placeholderColor:"#f0f0f0",blurUpSize:"10px",retryCount:3,retryDelay:2e3,preloadDistance:100,...e},this.observer=null,this.imageCache=new Map,this.retryQueue=new Map,this.init(),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&this.handleVisibilityChange()}),window.addEventListener("online",()=>this.handleNetworkChange(!0)),window.addEventListener("offline",()=>this.handleNetworkChange(!1)),this.scrollTimeout=null,window.addEventListener("scroll",()=>{this.scrollTimeout||(this.scrollTimeout=setTimeout(()=>{this.refreshObserver(),this.scrollTimeout=null},150))},{passive:!0})}init(){"IntersectionObserver"in window?(this.observer=new IntersectionObserver(this.handleIntersection.bind(this),{rootMargin:this.options.rootMargin,threshold:this.options.threshold}),this.observe()):this.loadAllImages(),this.addStyles()}handleIntersection(e,t){e.forEach(e=>{var t=e.target,a=e.intersectionRatio;e.isIntersecting&&(t.dataset.loading||this.loadImage(t,a),.5<a)&&this.preloadNearbyImages(t)})}async loadImage(t,e=0){if(!t.dataset.loading){t.dataset.loading="true",t.classList.add(this.options.loadingClass);var a=t.dataset.src,s=t.dataset.srcset,i=t.dataset.sizes;try{await this.applyBlurUpPlaceholder(t),await this.loadImageWithRetry(a,s,i),s&&(t.srcset=s,t.sizes=i),t.src=a,this.imageCache.set(a,!0),t.classList.remove(this.options.loadingClass),t.classList.add(this.options.loadedClass),this.cleanupDataAttributes(t),this.dispatchEvent(t,"lazyloaded")}catch(e){this.handleLoadError(t,e)}}}async loadImageWithRetry(t,a,s,i=0){try{return await this.loadImageData(t,a,s)}catch(e){if(i<this.options.retryCount)return await this.delay(this.options.retryDelay),this.loadImageWithRetry(t,a,s,i+1);throw e}}loadImageData(s,i,r){return new Promise((e,t)=>{let a=new Image;a.onload=()=>e({img:a,src:s}),a.onerror=()=>t(new Error("Failed to load image: "+s)),i&&(a.srcset=i,a.sizes=r),a.src=s})}async applyBlurUpPlaceholder(e){var t,a;e.dataset.src&&(a=(t=document.createElement("canvas")).getContext("2d"),t.width=40,t.height=40,a.fillStyle=this.options.placeholderColor,a.fillRect(0,0,t.width,t.height),e.style.filter=`blur(${this.options.blurUpSize})`,a=t.toDataURL("image/jpeg",.1),e.src=a)}preloadNearbyImages(e){this.getNearbyImages(e).forEach(e=>{e.dataset.loading||e.classList.contains(this.options.loadedClass)||this.loadImage(e,.1)})}getNearbyImages(e){var t=Array.from(document.querySelectorAll("img[data-src]"));t.indexOf(e);let a=this.options.preloadDistance;return t.filter((e,t)=>!e.classList.contains(this.options.loadedClass)&&(e=e.getBoundingClientRect(),Math.abs(e.top-window.innerHeight/2)<a))}handleLoadError(e,t){e.classList.remove(this.options.loadingClass),e.classList.add(this.options.errorClass),navigator.onLine&&this.retryQueue.set(e,{retryCount:0,lastAttempt:Date.now()}),this.dispatchEvent(e,"lazyloaderror",{error:t})}handleNetworkChange(e){e&&0<this.retryQueue.size&&this.retryFailedLoads()}handleVisibilityChange(){this.refreshObserver(),"visible"===document.visibilityState&&this.retryFailedLoads()}async retryFailedLoads(){for(var[e,t]of this.retryQueue.entries())if(t.retryCount<this.options.retryCount)try{await this.loadImage(e),this.retryQueue.delete(e)}catch(e){t.retryCount++,t.lastAttempt=Date.now()}}refreshObserver(){this.observer&&document.querySelectorAll("img[data-src]").forEach(e=>{e.classList.contains(this.options.loadedClass)||this.observer.observe(e)})}cleanupDataAttributes(t){["src","srcset","sizes","loading"].forEach(e=>{t.removeAttribute("data-"+e)})}dispatchEvent(e,t,a={}){t=new CustomEvent(t,{detail:{img:e,...a},bubbles:!0,cancelable:!0});e.dispatchEvent(t)}delay(t){return new Promise(e=>setTimeout(e,t))}addStyles(){var e=document.createElement("style");e.textContent=`
            .lazy-loading {
                opacity: 0.5;
                transition: opacity 0.3s ease-in-out, filter 0.5s ease-in-out;
            }
            
            .lazy-loaded {
                opacity: 1;
                filter: blur(0) !important;
                transition: opacity 0.3s ease-in-out, filter 0.5s ease-in-out;
            }
            
            .lazy-error {
                opacity: 0.2;
                filter: grayscale(100%);
                transition: opacity 0.3s ease-in-out;
            }
            
            img[data-src] {
                background: ${this.options.placeholderColor};
                transition: filter 0.5s ease-in-out;
            }
            
            @keyframes lazyShimmer {
                0% { background-position: -200% 0; }
                100% { background-position: 200% 0; }
            }
            
            .lazy-loading::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.2) 50%,
                    transparent 100%
                );
                background-size: 200% 100%;
                animation: lazyShimmer 1.5s infinite;
            }
        `,document.head.appendChild(e)}observe(){document.querySelectorAll("img[data-src]").forEach(e=>{this.observer&&!e.classList.contains(this.options.loadedClass)&&this.observer.observe(e)})}loadAllImages(){document.querySelectorAll("img[data-src]").forEach(e=>this.loadImage(e))}refresh(){this.observe(),this.retryFailedLoads()}}document.addEventListener("DOMContentLoaded",()=>{window.lazyLoader=new e({rootMargin:"50px 0px",threshold:[0,.25,.5,.75,1],loadingClass:"lazy-loading",loadedClass:"lazy-loaded",errorClass:"lazy-error",placeholderColor:"#f0f0f0",blurUpSize:"10px",retryCount:3,retryDelay:2e3,preloadDistance:100}),document.addEventListener("lazyload:refresh",()=>{window.lazyLoader.refresh()})});